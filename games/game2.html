<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bunny Adventure - Fair Game</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* CSS RIÊNG CHO TRANG CHI TIẾT (GIỮ NGUYÊN) */
        .game-detail-wrapper { max-width: 1000px; margin: 40px auto; padding: 20px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; }
        .top-section { display: flex; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 30px; }
        .detail-img { width: 350px; height: 300px; object-fit: cover; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #444; }
        .detail-info { flex: 1; }
        .detail-info h1 { font-size: 3em; color: #fff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .detail-info .price { font-size: 2.5em; color: #e74c3c; font-weight: bold; margin: 15px 0; text-shadow: 0 0 10px rgba(231,76,60,0.4); }
        .detail-info .desc { color: #ccc; line-height: 1.6; margin-bottom: 25px; font-size: 1.1em; }
        .big-btn { padding: 15px 40px; font-size: 1.2em; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; text-transform: uppercase; }
        .big-btn:hover { background: #c0392b; transform: scale(1.05); box-shadow: 0 0 20px #c0392b; }

        .section-title { color: #fff; border-left: 5px solid #e74c3c; padding-left: 15px; margin: 30px 0 20px 0; font-size: 1.5em; text-transform: uppercase; }
        .req-table { width: 100%; border-collapse: collapse; background: #252525; border-radius: 8px; overflow: hidden; margin-bottom: 40px; }
        .req-table th, .req-table td { padding: 15px; text-align: left; border-bottom: 1px solid #333; color: #ccc; }
        .req-table th { background-color: #2c2c2c; color: #e74c3c; width: 25%; font-weight: bold; }

        .review-form-container { background-color: #252525; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #fff; }
        .form-input { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #1e1e1e; color: white; font-family: 'Rajdhani', sans-serif; }
        textarea.form-input { resize: vertical; height: 80px; }
        
        .star-widget { display: flex; gap: 5px; direction: ltr; margin-bottom: 10px; }
        .star-widget span { font-size: 30px; color: #444; cursor: pointer; transition: color 0.2s; }
        .star-widget span.hovered, .star-widget span.selected { color: #f1c40f; }

        .submit-btn { background-color: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .submit-btn:hover { background-color: #219150; box-shadow: 0 0 10px #27ae60; }

        .review-list { display: flex; flex-direction: column; gap: 15px; }
        .review-card { background-color: #252525; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #555; }
        .user-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .username { font-weight: bold; color: #fff; }
        .rating { color: #f1c40f; letter-spacing: 2px; }
        .review-date { font-size: 0.8em; color: #777; display: block; margin-bottom: 5px; }
        .review-text { color: #ccc; line-height: 1.5; }

        #loginWarning {
            background: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; color: #e74c3c;
            padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 30px; display: none;
        }
        #loginWarning a { color: #fff; text-decoration: underline; font-weight: bold; }

        @media(max-width: 768px) {
            .top-section { flex-direction: column; }
            .detail-img { width: 100%; height: auto; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">FAIR GAME</div>
        <nav>
            <a href="../index.html">Trang chủ</a>
            <a href="../docquyen.html">Game độc quyền</a>
            <a href="../aboutus.html">About us</a>
        </nav>
        <div class="header-right">
            <div class="cart-icon" onclick="toggleCart()">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count">0</span>
            </div>
            <div class="user-box" id="userBox">
                <a href="../login.html">Đăng nhập</a>
            </div>
        </div>
    </header>

    <div class="game-detail-wrapper">
        
        <div class="top-section">
            <img src="../images/bunny.png" alt="Bunny Adventure" class="detail-img">
            <div class="detail-info">
                <h1>Bunny Adventure</h1> 
                <p style="color:#888; font-style: italic;">Thể loại: Adventure / Platformer</p>
                <p class="price">Free</p> 
                <p class="desc">
                    Hóa thân thành chú thỏ dũng cảm trong hành trình giải cứu khu rừng kỳ diệu. 
                    Vượt qua các chướng ngại vật, thu thập cà rốt và đánh bại quái vật. 
                    Đồ họa dễ thương, lối chơi cuốn hút phù hợp mọi lứa tuổi!
                </p>
                
                <button class="big-btn" onclick="addToCart('Bunny Adventure', 0, '../images/bunny.png')">
                    <i class="fas fa-cart-plus"></i> Thêm vào giỏ
                </button>
            </div>
        </div>

        <h2 class="section-title">Yêu cầu hệ thống</h2>
        <table class="req-table">
            <tr><th>OS</th><td>Windows 10 / 11</td></tr>
            <tr><th>CPU</th><td>Intel Core i3 / AMD Ryzen 3</td></tr>
            <tr><th>RAM</th><td>4 GB RAM</td></tr>
            <tr><th>GPU</th><td>Intel HD Graphics 620</td></tr>
            <tr><th>Storage</th><td>200 MB available space</td></tr>
        </table>

        <h2 class="section-title">Đánh giá từ người chơi</h2>
        
        <div id="loginWarning">
            Bạn cần <a href="../login.html">Đăng nhập</a> để viết đánh giá.
        </div>

        <div class="review-form-container" id="reviewForm" style="display: none;">
            <div class="form-group">
                <label>Đang đánh giá dưới tên: <span id="currentUserLabel" style="color: #e74c3c;">...</span></label>
            </div>
            <div class="form-group">
                <label>Đánh giá:</label>
                <div class="star-widget" id="starWidget">
                    <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
                </div>
                <input type="hidden" id="ratingValue" value="0">
                <div id="ratingText" style="color: #888; font-size: 0.9em;">Chưa chọn sao</div>
            </div>
            <div class="form-group">
                <label>Nội dung:</label>
                <textarea id="inputComment" class="form-input" placeholder="Game có vui không? Chia sẻ ngay..."></textarea>
            </div>
            <button class="submit-btn" id="btnSubmitReview">Gửi đánh giá</button>
        </div>

        <div id="reviewList" class="review-list">
            <p style="color:#888; text-align:center">Đang tải bình luận...</p>
        </div>
    </div>

    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3>Giỏ hàng</h3>
            <button onclick="toggleCart()" class="close-btn">&times;</button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-footer">
            <p>Tổng tiền: <span id="cartTotal">$0.00</span></p>
            <button class="checkout-btn" onclick="openCheckout()">Thanh toán</button>
        </div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleCart()"></div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCheckout()">&times;</span>
            <h2>Thanh toán</h2>
            <p>Điền thông tin để nhận key game qua email</p>
            <form onsubmit="processPayment(event)">
                <input type="text" placeholder="Họ tên" required class="input-field">
                <input type="email" placeholder="Email nhận key" required class="input-field">
                <div class="payment-summary">Tổng tiền: <span id="paymentTotal">$0.00</span></div>
                <button type="submit" class="pay-btn">Xác nhận thanh toán</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "../firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // !!! QUAN TRỌNG: ID RIÊNG CHO GAME 2 !!!
        const GAME_ID = 'game2_reviews'; 

        let currentUser = null;

        // 1. Kiểm tra đăng nhập
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('reviewForm').style.display = 'block';
                document.getElementById('loginWarning').style.display = 'none';
                document.getElementById('currentUserLabel').innerText = user.email;
            } else {
                currentUser = null;
                document.getElementById('reviewForm').style.display = 'none';
                document.getElementById('loginWarning').style.display = 'block';
            }
        });

        // 2. Xử lý sao
        const stars = document.querySelectorAll('.star-widget span');
        const ratingValueInput = document.getElementById('ratingValue');
        const ratingText = document.getElementById('ratingText');
        const ratingLabels = ["Rất tệ", "Tệ", "Bình thường", "Tốt", "Tuyệt vời"];
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                ratingValueInput.value = index + 1;
                highlightStars(index + 1);
                ratingText.innerText = ratingLabels[index];
                ratingText.style.color = "#f1c40f";
            });
        });

        function highlightStars(count) {
            stars.forEach((s, i) => {
                if (i < count) { s.classList.add('selected'); s.style.color = "#f1c40f"; } 
                else { s.classList.remove('selected'); s.style.color = "#444"; }
            });
        }

        // 3. Gửi đánh giá
        document.getElementById('btnSubmitReview').addEventListener('click', () => {
            if (!currentUser) return;
            const comment = document.getElementById('inputComment').value.trim();
            const starsSelected = parseInt(ratingValueInput.value);

            if (comment === "") { alert("Vui lòng nhập nội dung!"); return; }
            if (starsSelected === 0) { alert("Vui lòng chọn số sao!"); return; }

            const reviewsRef = ref(db, 'reviews/' + GAME_ID);
            push(reviewsRef, {
                user: currentUser.email,
                stars: starsSelected,
                content: comment,
                createdAt: new Date().toLocaleString('vi-VN')
            }).then(() => {
                document.getElementById('inputComment').value = '';
                ratingValueInput.value = 0;
                highlightStars(0);
                alert("Đã gửi đánh giá!");
            });
        });

        // 4. Tải đánh giá
        const reviewsRef = ref(db, 'reviews/' + GAME_ID);
        onValue(reviewsRef, (snapshot) => {
            const list = document.getElementById('reviewList');
            list.innerHTML = "";
            if (snapshot.exists()) {
                const reviews = Object.values(snapshot.val()).reverse();
                reviews.forEach(review => {
                    const starString = '★'.repeat(review.stars) + '☆'.repeat(5 - review.stars);
                    const avatarChar = review.user.charAt(0).toUpperCase();
                    list.innerHTML += `
                        <div class="review-card">
                            <div class="user-header">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="width:30px; height:30px; background:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#e74c3c; font-weight:bold;">${avatarChar}</div>
                                    <span class="username">${review.user}</span>
                                </div>
                                <span class="rating">${starString}</span>
                            </div>
                            <span class="review-date">${review.createdAt}</span>
                            <p class="review-text">${review.content}</p>
                        </div>
                    `;
                });
            } else {
                list.innerHTML = "<p style='color:#666; text-align:center'>Chưa có đánh giá nào.</p>";
            }
        });
    </script>
    <script type="module" src="../script.js"></script>
</body>
</html>