<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG Mobile - Fair Game</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* GI·ªÆ NGUY√äN CSS C·ª¶A game1 */
        .game-detail-wrapper { max-width: 1000px; margin: 40px auto; padding: 20px; background: #1e1e1e; border-radius: 8px; }
        .top-section { display: flex; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 30px; }
        .detail-img { width: 350px; height: 300px; object-fit: cover; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .detail-info { flex: 1; }
        .detail-info h1 { font-size: 2.8em; color: #fff; margin-bottom: 10px; }
        .detail-info .price { font-size: 2em; color: #e74c3c; font-weight: bold; margin: 15px 0; }
        .detail-info .desc { color: #ccc; line-height: 1.6; margin-bottom: 25px; font-size: 1.1em; }
        .big-btn { padding: 15px 40px; font-size: 1.2em; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .big-btn:hover { background: #c0392b; transform: scale(1.05); }

        .section-title { color: #fff; border-left: 5px solid #e74c3c; padding-left: 15px; margin: 30px 0 20px 0; font-size: 1.5em; }
        .req-table { width: 100%; border-collapse: collapse; background: #252525; border-radius: 8px; overflow: hidden; margin-bottom: 40px; }
        .req-table th, .req-table td { padding: 15px; text-align: left; border-bottom: 1px solid #333; color: #ccc; }
        .req-table th { background-color: #2c2c2c; color: #e74c3c; width: 25%; font-weight: bold; }

        .review-form-container { background-color: #252525; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #fff; }
        .form-input { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #1e1e1e; color: white; }
        textarea.form-input { resize: vertical; height: 80px; font-family: inherit; }
        
        .star-widget { display: flex; gap: 5px; direction: ltr; margin-bottom: 10px; }
        .star-widget span { font-size: 30px; color: #444; cursor: pointer; transition: color 0.2s; }
        .star-widget span.hovered, .star-widget span.selected { color: #f1c40f; }

        .submit-btn { background-color: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .submit-btn:hover { background-color: #219150; }

        .review-list { display: flex; flex-direction: column; gap: 15px; }
        .review-card { background-color: #252525; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #555; }
        .user-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .username { font-weight: bold; color: #fff; }
        .rating { color: #f1c40f; letter-spacing: 2px; }
        .review-date { font-size: 0.8em; color: #777; display: block; margin-bottom: 5px; }
        .review-text { color: #ccc; line-height: 1.5; }

        #loginWarning { background: rgba(231, 76, 60, 0.1); border: 1px solid #e74c3c; color: #e74c3c; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 30px; display: none; }
        #loginWarning a { color: #fff; text-decoration: underline; font-weight: bold; }

        @media(max-width: 768px) { .top-section { flex-direction: column; } .detail-img { width: 100%; height: auto; } }
    </style>
</head>
<body>

    <header>
        <div class="logo">FAIR GAME</div>
        <nav>
            <a href="../index.html">Trang ch·ªß</a>
            <a href="../docquyen.html">Game ƒë·ªôc quy·ªÅn</a>
            <a href="../aboutus.html">About us</a>
        </nav>

        <div class="header-right">
            <div class="cart-icon" onclick="toggleCart()">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count">0</span>
            </div>
            <div class="user-box" id="userBox">
                <a href="../login.html">ƒêƒÉng nh·∫≠p</a>
            </div>
        </div>
    </header>

    <div class="game-detail-wrapper">
        
        <div class="top-section">
            <img src="../images/pubg.jpg" alt="PUBG Mobile" class="detail-img">
            <div class="detail-info">
                <h1>PUBG Mobile</h1>
                <p style="color:#888; font-style: italic;">Th·ªÉ lo·∫°i: Shooter</p>
                <p class="price">Free</p>
                <p class="desc">Phi√™n b·∫£n mobile c·ªßa t·ª±a game b·∫Øn s√∫ng sinh t·ªìn n·ªïi ti·∫øng, ch∆°i ƒë∆°n ho·∫∑c squad c√πng b·∫°n b√®.</p>
                <button class="big-btn" onclick="addToCart('PUBG Mobile', 0, '../images/pubg.jpg')"><i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè</button>
            </div>
        </div>

        <h2 class="section-title">Y√™u c·∫ßu h·ªá th·ªëng</h2>
        <table class="req-table">
            <tr><th>OS</th><td>Android/iOS</td></tr>
            <tr><th>CPU</th><td>ARM Quad-core</td></tr>
            <tr><th>RAM</th><td>2 GB RAM</td></tr>
            <tr><th>GPU</th><td>Adreno/PowerVR</td></tr>
            <tr><th>Storage</th><td>200 MB available space</td></tr>
        </table>

        <h2 class="section-title">ƒê√°nh gi√° t·ª´ ng∆∞·ªùi ch∆°i</h2>
        <div id="loginWarning">B·∫°n c·∫ßn <a href="../login.html">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ vi·∫øt ƒë√°nh gi√°.</div>
        <div class="review-form-container" id="reviewForm" style="display: none;">
            <div class="form-group"><label>ƒêang ƒë√°nh gi√° d∆∞·ªõi t√™n: <span id="currentUserLabel" style="color: #e74c3c;">...</span></label></div>
            <div class="form-group"><label>ƒê√°nh gi√°:</label><div class="star-widget" id="starWidget"><span data-value="1">‚òÖ</span><span data-value="2">‚òÖ</span><span data-value="3">‚òÖ</span><span data-value="4">‚òÖ</span><span data-value="5">‚òÖ</span></div>
            <input type="hidden" id="ratingValue" value="0"><div id="ratingText" style="color: #888; font-size: 0.9em;">Ch∆∞a ch·ªçn sao</div></div>
            <div class="form-group"><label>N·ªôi dung:</label><textarea id="inputComment" class="form-input" placeholder="Chia s·∫ª c·∫£m nghƒ© c·ªßa b·∫°n..."></textarea></div>
            <button class="submit-btn" id="btnSubmitReview">G·ª≠i ƒë√°nh gi√°</button>
        </div>

        <div id="reviewList" class="review-list"><p style="color:#888; text-align:center">ƒêang t·∫£i b√¨nh lu·∫≠n...</p></div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section"><h3>Fair Game Store</h3><p>N∆°i cung c·∫•p game b·∫£n quy·ªÅn uy t√≠n, gi√° r·∫ª h√†ng ƒë·∫ßu Vi·ªát Nam.</p></div>
            <div class="footer-section"><h3>Li√™n h·ªá</h3><p>Email: hotro@fairgame.vn</p><p>SƒêT: 0123.456.789</p><div class="socials"><i class="fab fa-facebook"></i><i class="fab fa-instagram"></i><i class="fab fa-discord"></i></div></div>
            <div class="footer-section"><h3>Ch√≠nh s√°ch</h3><p><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></p><p><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></p><p><a href="#">Ho√†n ti·ªÅn</a></p></div>
        </div>
        <div class="footer-bottom">&copy; 2025 Fair Games | Upgrade by You</div>
    </footer>

    <div class="cart-sidebar" id="cartSidebar"><div class="cart-header"><h3>Gi·ªè h√†ng</h3><button onclick="toggleCart()" class="close-btn">&times;</button></div><div class="cart-items" id="cartItems"></div><div class="cart-footer"><p>T·ªïng ti·ªÅn: <span id="cartTotal">$0.00</span></p><button class="checkout-btn" onclick="openCheckout()">Thanh to√°n</button></div></div>
    <div class="overlay" id="overlay" onclick="toggleCart()"></div>
    <div id="paymentModal" class="modal"><div class="modal-content payment-box"><span class="close-modal" onclick="closePaymentModal()">&times;</span><div class="payment-header"><h2>THANH TO√ÅN ƒê∆†N H√ÄNG</h2></div><div class="payment-container"><div class="qr-section"><p>Qu√©t m√£ b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng:</p><div class="qr-wrapper"><img id="qrImage" src="" alt="QR Code" class="qr-img"></div><div class="transfer-note">N·ªôi dung chuy·ªÉn kho·∫£n b·∫Øt bu·ªôc:<span id="transferContent" class="transfer-code">Loading...</span></div></div><div class="info-section"><h3>Th√¥ng tin thanh to√°n</h3><p>T·ªïng ti·ªÅn c·∫ßn thanh to√°n:</p><p id="payAmount" class="total-price">0ƒë</p><div class="bank-card"><p>Ng√¢n h√†ng: <b>MB Bank</b></p><p>Ch·ªß t√†i kho·∫£n: <b>DO QUANG THANG</b></p><p>S·ªë t√†i kho·∫£n: <b style="color: #f1c40f; font-size: 1.2em;">0357876625</b></p></div><p style="font-style: italic; font-size: 0.9em; color: #888; margin-bottom: 20px;"><i class="fas fa-info-circle"></i> L∆∞u √Ω: H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω sau khi b·∫°n chuy·ªÉn kho·∫£n th√†nh c√¥ng. Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát.</p><button class="confirm-pay-btn" onclick="confirmPayment()"><i class="fas fa-check-circle"></i> T√îI ƒê√É CHUY·ªÇN KHO·∫¢N</button></div></div></div></div>

    <script type="module">
        import { auth, db } from "../firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // üëá Th√™m 'get' v√†o d√≤ng import n√†y ƒë·ªÉ l·∫•y d·ªØ li·ªáu avatar
        import { ref, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // !!! QUAN TR·ªåNG: ID C·ª¶A GAME (Nh·ªõ s·ª≠a d√≤ng n√†y khi copy sang game kh√°c)
        const GAME_ID = 'game3_reviews'; 

        let currentUser = null;

        // 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('reviewForm').style.display = 'block';
                document.getElementById('loginWarning').style.display = 'none';
                document.getElementById('currentUserLabel').innerText = user.displayName || user.email;
            } else {
                currentUser = null;
                document.getElementById('reviewForm').style.display = 'none';
                document.getElementById('loginWarning').style.display = 'block';
            }
        });

        // 2. LOGIC NG√îI SAO (ƒê√É FIX & C√ì HOVER)
        const stars = document.querySelectorAll('.star-widget span');
        const widget = document.getElementById('starWidget');
        const ratingValueInput = document.getElementById('ratingValue');
        const ratingText = document.getElementById('ratingText');
        const ratingLabels = ["R·∫•t t·ªá", "T·ªá", "B√¨nh th∆∞·ªùng", "T·ªët", "Tuy·ªát v·ªùi"];
        
        function highlightStars(count) {
            stars.forEach((s, i) => {
                if (i < count) { s.classList.add('selected'); s.style.color = "#f1c40f"; } 
                else { s.classList.remove('selected'); s.style.color = "#444"; }
            });
        }

        stars.forEach((star, index) => {
            star.addEventListener('mouseover', () => { highlightStars(index + 1); ratingText.innerText = ratingLabels[index]; ratingText.style.color = "#f1c40f"; });
            star.addEventListener('click', () => { ratingValueInput.value = index + 1; star.style.transform = "scale(1.3)"; setTimeout(()=> star.style.transform = "scale(1)", 200); });
        });

        widget.addEventListener('mouseleave', () => {
            const currentRating = parseInt(ratingValueInput.value);
            if (currentRating > 0) { highlightStars(currentRating); ratingText.innerText = ratingLabels[currentRating - 1]; } 
            else { highlightStars(0); ratingText.innerText = "Ch∆∞a ch·ªçn sao"; ratingText.style.color = "#888"; }
        });

        // 3. G·ª¨I ƒê√ÅNH GI√Å (C√ì K√àM AVATAR)
        document.getElementById('btnSubmitReview').addEventListener('click', () => {
            if (!currentUser) return;
            const comment = document.getElementById('inputComment').value.trim();
            const starsSelected = parseInt(ratingValueInput.value);

            if (starsSelected === 0) { alert("Vui l√≤ng ch·ªçn s·ªë sao!"); return; }
            if (comment === "") { alert("Vui l√≤ng nh·∫≠p n·ªôi dung!"); return; }

            const btn = document.getElementById('btnSubmitReview');
            btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;

            // üëá B∆Ø·ªöC M·ªöI: L·∫•y Avatar c·ªßa User tr∆∞·ªõc khi l∆∞u comment
            const userRef = ref(db, 'users/' + currentUser.uid);
            get(userRef).then((snapshot) => {
                let userAvatar = ""; // M·∫∑c ƒë·ªãnh kh√¥ng c√≥
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.avatar) userAvatar = userData.avatar;
                }

                // Sau khi l·∫•y ƒë∆∞·ª£c avatar, ti·∫øn h√†nh l∆∞u Comment
                const reviewsRef = ref(db, 'reviews/' + GAME_ID);
                push(reviewsRef, {
                    user: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    avatar: userAvatar, // üëá L∆∞u avatar v√†o ƒë√¢y
                    stars: starsSelected,
                    content: comment,
                    createdAt: new Date().toLocaleString('vi-VN')
                }).then(() => {
                    document.getElementById('inputComment').value = '';
                    ratingValueInput.value = 0;
                    highlightStars(0);
                    ratingText.innerText = "Ch∆∞a ch·ªçn sao";
                    ratingText.style.color = "#888";
                    alert("ƒê√°nh gi√° th√†nh c√¥ng!");
                }).catch(() => alert("L·ªói k·∫øt n·ªëi!")).finally(() => {
                    btn.innerText = "G·ª≠i ƒë√°nh gi√°"; btn.disabled = false;
                });
            });
        });

        // 4. LOAD ƒê√ÅNH GI√Å (HI·ªÇN TH·ªä AVATAR TH·∫¨T)
        const reviewsRef = ref(db, 'reviews/' + GAME_ID);
        onValue(reviewsRef, (snapshot) => {
            const list = document.getElementById('reviewList');
            list.innerHTML = "";
            if (snapshot.exists()) {
                const reviews = Object.values(snapshot.val()).reverse();
                reviews.forEach(review => {
                    const starString = '‚òÖ'.repeat(review.stars) + '‚òÜ'.repeat(5 - review.stars);
                    const avatarChar = review.user.charAt(0).toUpperCase();

                    // üëá LOGIC HI·ªÇN TH·ªä AVATAR
                    let avatarHTML = "";
                    if (review.avatar && review.avatar.length > 100) { 
                        // N·∫øu c√≥ ·∫£nh base64 d√†i -> Hi·ªán ·∫£nh
                        avatarHTML = `<img src="${review.avatar}" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border: 2px solid #e74c3c;">`;
                    } else {
                        // N·∫øu kh√¥ng c√≥ ·∫£nh -> Hi·ªán ch·ªØ c√°i ƒë·∫ßu (nh∆∞ c≈©)
                        avatarHTML = `<div style="width:35px; height:35px; background:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#e74c3c; font-weight:bold; border: 1px solid #555;">${avatarChar}</div>`;
                    }

                    list.innerHTML += `
                        <div class="review-card">
                            <div class="user-header">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    ${avatarHTML} 
                                    <div>
                                        <span class="username">${review.user}</span>
                                        <span class="review-date" style="font-size:0.8em; color:#777;">${review.createdAt}</span>
                                    </div>
                                </div>
                                <span class="rating">${starString}</span>
                            </div>
                            <p class="review-text" style="margin-top:10px; padding-left:45px;">${review.content}</p>
                        </div>`;
                });
            } else {
                list.innerHTML = "<p style='color:#666;text-align:center'>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>";
            }
        });
    </script>
    
    <script type="module" src="../firebase.js"></script>
    <script type="module" src="../auth.js"></script>
    <script type="module" src="../script.js"></script>
</body>
</html>
