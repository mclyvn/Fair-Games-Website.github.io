<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Game Thủ - Fair Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS RIÊNG CHO TRANG PROFILE */
        body { background: #0b0b0b; }
        
        .profile-container {
            max-width: 1200px; margin: 50px auto; padding: 20px;
            display: grid; grid-template-columns: 350px 1fr; gap: 40px;
        }

        /* --- SIDEBAR --- */
        .profile-sidebar {
            background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px; border-radius: 15px; text-align: center; height: fit-content;
        }
        .user-avatar {
            width: 140px; height: 140px; margin: 0 auto 20px;
            border-radius: 50%; border: 4px solid #e74c3c;
            background: #111; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            font-size: 60px; color: #e74c3c; cursor: pointer;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
        }
        #avatarImg { width: 100%; height: 100%; object-fit: cover; }
        .avatar-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 30px; opacity: 0; transition: 0.3s;
        }
        .user-avatar:hover .avatar-overlay { opacity: 1; }

        .display-name { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 5px; text-transform: uppercase; }
        .username { color: #888; font-size: 16px; margin-bottom: 20px; font-style: italic; }

        .action-btn {
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: 0.3s; border: none;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Rajdhani', sans-serif;
        }
        .edit-profile-btn { background: #333; color: white; border: 1px solid #555; }
        .edit-profile-btn:hover { background: #444; border-color: #fff; }
        .sell-game-btn { background: linear-gradient(45deg, #f1c40f, #e67e22); color: #000; }
        .sell-game-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3); }
        .sell-game-btn.pending { background: #555; color: #aaa; cursor: not-allowed; transform: none; box-shadow: none; }
        .logout-btn-profile { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; margin-top: 10px; }
        .logout-btn-profile:hover { background: #e74c3c; color: white; }

        /* --- CONTENT --- */
        .profile-content h2 {
            border-left: 5px solid #e74c3c; padding-left: 15px; margin-bottom: 25px;
            text-transform: uppercase; color: #fff; letter-spacing: 2px; font-size: 22px;
            margin-top: 40px; /* Cách xa phần trên một chút */
        }
        .profile-content h2:first-child { margin-top: 0; }

        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;
            background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-label { color: #888; font-size: 14px; margin-bottom: 5px; }
        .info-value { color: #fff; font-size: 18px; font-weight: 600; }
        .bio-box { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 40px; }
        .bio-text { color: #ccc; line-height: 1.6; font-style: italic; }

        /* Order & Wishlist Item Style */
        .order-card { background: #1a1a1a; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; color: #888; }
        .order-header .order-date { color: #fff; font-weight: 700; }

        .game-list { display: flex;flex-direction: column; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }

        .purchased-game { display: flex; align-items: center; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #444; gap: 15px; position: relative; }
        .purchased-game img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .game-info h4 { margin: 0 0 5px 0; color: white; }
        .game-info p { margin: 0; color: #e74c3c; font-weight: 700; }
        
        .download-btn { margin-left:auto; background:#27ae60; color:white; border:none; padding:6px 12px; border-radius:4px; text-decoration:none; font-size:0.9rem; display:inline-flex; align-items:center; gap:5px; transition: 0.2s; }
        .download-btn:hover { background: #2ecc71; transform: translateY(-2px); }
        .download-btn.disabled { background: #7f8c8d; cursor: not-allowed; transform: none; }

        /* Nút xóa wishlist */
        .remove-wish-btn {
            position: absolute; top: 10px; right: 10px; color: #666; cursor: pointer; transition: 0.2s;
        }
        .remove-wish-btn:hover { color: #e74c3c; }

        /* MODAL STYLES */
        .modal { display: none; }
        .edit-form-group { margin-bottom: 15px; text-align: left; }
        .edit-form-group label { display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9em; }
        .edit-input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; font-family: 'Rajdhani', sans-serif; }
        .edit-input:focus { border-color: #e74c3c; outline: none; }
        
        /* Seller Modal */
        .seller-modal-content { display: flex; flex-direction: column; max-height: 90vh; background: #000; width: 90%; max-width: 800px; padding: 0; border: 1px solid #333; border-radius: 8px; position: relative; }
        .modal-header-red { background: #990000; color: white; text-align: center; padding: 15px; font-size: 24px; font-weight: bold; text-transform: uppercase; flex-shrink: 0; }
        .modal-body { padding: 30px; overflow-y: auto; }
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #111; }
        .modal-body::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        .intro-text { color: #fff; font-size: 0.9em; margin-bottom: 25px; line-height: 1.5; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .form-section-title { color: #fff; font-weight: bold; margin: 20px 0 15px 0; display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
        .form-section-title i { color: #27ae60; } 
        .upload-area { border: 2px dashed #444; background: #111; padding: 30px; text-align: center; color: #888; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #e74c3c; color: #fff; }

        @media (max-width: 768px) { .profile-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        <div class="logo">FAIR GAME</div>
        <nav>
            <a href="index.html">Trang chủ</a>
            <a href="docquyen.html">Game độc quyền</a>
            <a href="aboutus.html">About us</a>
        </nav>
        <div class="header-right">
            <div class="cart-icon" onclick="toggleCart()">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count">0</span>
            </div>
            <div class="user-box" id="userBox"></div>
        </div>
    </header>

    <div class="profile-container">
        <div class="profile-sidebar">
            <div class="user-avatar" onclick="document.getElementById('avatarInput').click()">
                <img id="avatarImg" src="" alt="Avatar" style="display: none;">
                <i id="defaultIcon" class="fas fa-user-astronaut"></i>
                <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">

            <div id="displayName" class="display-name">Loading...</div>
            <div id="username" class="username">@loading</div>

            <button onclick="openEditModal()" class="action-btn edit-profile-btn">
                <i class="fas fa-user-edit"></i> Chỉnh sửa hồ sơ
            </button>

            <button id="btnSellGame" onclick="openSellGameModal()" class="action-btn sell-game-btn">
                <i class="fas fa-gamepad"></i> Đăng ký bán Game
            </button>
            
            <button onclick="logout()" class="action-btn logout-btn-profile">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>

        <div class="profile-content">
            <h2>Thông tin cá nhân</h2>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Email</span><span id="displayEmail" class="info-value">...</span></div>
                <div class="info-item"><span class="info-label">Số điện thoại</span><span id="displayPhone" class="info-value">...</span></div>
                <div class="info-item"><span class="info-label">Ngày tham gia</span><span id="joinDate" class="info-value">...</span></div>
                <div class="info-item"><span class="info-label">Số Game đã mua</span><span id="gamesOwned" class="info-value" style="color: #e74c3c;">0</span></div>
                <div class="info-item"><span class="info-label">Sở thích</span><span id="interests" class="info-value">...</span></div>
            </div>
            
            <h2>Giới thiệu</h2>
            <div class="bio-box"><p id="userBio" class="bio-text">...</p></div>

            <h2 class="collapsible-header" onclick="toggleSection('wishlistSection', this)">
                Danh Sách Yêu Thích <i class="fas fa-chevron-down"></i>
            </h2>

            <div id="wishlistSection" class="content-section">
                <div id="wishlistLoading"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>
                <div id="wishlistContainer" class="game-list" style="margin-bottom: 40px;">
                    </div>
            </div>

            <h2 class="collapsible-header" onclick="toggleSection('librarySection', this)">
                Thư Viện Game Đã Mua <i class="fas fa-chevron-down"></i>
            </h2>

            <div id="librarySection" class="content-section">
                <div id="loading"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</div>
                <div id="ordersList">
                    </div>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">CHỈNH SỬA HỒ SƠ</h2>
            <form onsubmit="saveProfileChanges(event)">
                <div class="edit-form-group"><label>Tên hiển thị</label><input type="text" id="editDisplayName" class="edit-input" required></div>
                <div class="edit-form-group"><label>Username</label><input type="text" id="editUsername" class="edit-input"></div>
                <div class="edit-form-group"><label>Số điện thoại</label><input type="text" id="editPhone" class="edit-input"></div> <div class="edit-form-group"><label>Sở thích</label><input type="text" id="editInterests" class="edit-input"></div>
                <div class="edit-form-group"><label>Bio</label><textarea id="editBio" class="edit-input" style="height: 80px;"></textarea></div>
                <button type="submit" class="pay-btn" style="width: 100%;">LƯU THAY ĐỔI</button>
            </form>
        </div>
    </div>

    <div id="sellGameModal" class="modal">
        <div class="modal-content seller-modal-content">
            <span class="close-modal" onclick="closeSellGameModal()" style="color: white; top: 15px; right: 20px; z-index: 10;">&times;</span>
            <div class="modal-header-red">Fair game</div>
            <div class="modal-body">
                <p class="intro-text">"Bạn là nhà phát triển độc lập tài năng?..."</p>
                <form onsubmit="submitSellerRequest(event)">
                    <div class="form-section-title"><i class="fas fa-puzzle-piece"></i> Thông tin nhà phát triển</div>
                    <div class="edit-form-group"><label>Tên nhà phát triển / Studio <span style="color:#e74c3c">*</span></label><input type="text" id="sellerStudioName" class="edit-input" required></div>
                    <div class="edit-form-group"><label>Email liên hệ <span style="color:#e74c3c">*</span></label><input type="email" id="sellerContactEmail" class="edit-input" required></div>
                    <div class="edit-form-group"><label>Phone number</label><input type="text" id="sellerPhone" class="edit-input"></div>
                    <div class="form-section-title"><i class="fas fa-gamepad"></i> Thông tin về game</div>
                    <div class="edit-form-group"><label>Tên game <span style="color:#e74c3c">*</span></label><input type="text" id="gameName" class="edit-input" required></div>
                    <div class="edit-form-group"><label>Thể loại <span style="color:#e74c3c">*</span></label><input type="text" id="gameGenre" class="edit-input" required></div>
                    <div class="edit-form-group"><label>Giá đề xuất (USD) <span style="color:#e74c3c">*</span></label><input type="number" id="gamePrice" class="edit-input" required></div>
                    <div class="edit-form-group"><label>Mô tả game <span style="color:#e74c3c">*</span></label><textarea id="gameDesc" class="edit-input" style="height: 100px;" required></textarea></div>
                    <div class="form-section-title">Upload file game</div>
                    <div class="edit-form-group">
                        <div class="upload-area" onclick="document.getElementById('gameFileUpload').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <p>Kéo thả file vào đây hoặc bấm để chọn</p>
                            <input type="file" id="gameFileUpload" style="display: none;">
                            <p id="fileNameDisplay" style="color: #27ae60; font-size: 0.9em; margin-top: 5px;"></p>
                        </div>
                    </div>
                    <button type="submit" class="pay-btn" style="width: 100%; background: #990000; border: none; font-size: 1.1em; margin-top: 20px;">GỬI ĐĂNG KÝ</button>
                </form>
            </div>
        </div>
    </div>

    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header"><h3>Giỏ hàng</h3><button onclick="toggleCart()" class="close-btn">&times;</button></div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-footer"><p>Tổng: <span id="cartTotal">$0.00</span></p><button class="checkout-btn" onclick="openCheckout()">Thanh toán</button></div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleCart()"></div>

    <div id="paymentModal" class="modal">
        <div class="modal-content payment-box">
            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            <h2 style="color: #e74c3c; text-align: center; margin-bottom: 20px;">THANH TOÁN</h2>
            <div class="payment-container">
                <div class="qr-section"><p>Quét mã:</p><img id="qrImage" src="" alt="QR" class="qr-img"><p style="font-size: 0.9em; margin-top: 10px;">Nội dung: <b id="transferContent">FWG123</b></p></div>
                <div class="info-section">
                    <h3>Thông tin đơn hàng</h3><p>Tổng tiền: <span id="payAmount" style="color:#e74c3c;font-weight:bold;font-size:1.5em;">0đ</span></p>
                    <div class="bank-info"><p>MB Bank</p><p>DO QUANG THANG</p><p>0357876625</p></div>
                    <button class="confirm-pay-btn" onclick="confirmPayment()"><i class="fas fa-check-circle"></i> TÔI ĐÃ THANH TOÁN</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { ref, onValue, update, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        let currentUserUID = null;
        let currentProfileData = {};
        
        // --- 1. KHO DỮ LIỆU GAME (Để hiển thị Wishlist) ---
        const GAME_LIBRARY = {
            "Ace Slayer": { img: "images/slayer.png", price: "Free" },
            "Bunny Adventure": { img: "images/bunny.png", price: "Free" },
            "PUBG Mobile": { img: "images/pubg.jpg", price: "Free" },
            "Elden Ring": { img: "images/eden-ring.jpg", price: "$59.99" },
            "FreeFire": { img: "images/freefire.jpg", price: "Free" },
            "Earth 2130": { img: "images/earth2130.png", price: "Free" },
            "UFO Attack": { img: "images/ufo.png", price: "Free" },
            "Apple Collector": { img: "images/apple.png", price: "Free" },
            "Monster Hunter": { img: "images/monsterhunter.avif", price: "$29.99" },
            "Resident Evil": { img: "images/residentevil4.webp", price: "$29.99" },
            "ARK: Survival Ascended": { img: "images/ark.webp", price: "$19.99" },
            "Minecraft": { img: "images/minecraft.jpg", price: "$26.99" }
        };

        const GAME_SOURCE = { "Ace Slayer": "https://tinyurl.com/fairgame-demo", "Elden Ring": "https://store.steampowered.com/app/1245620/Elden_Ring/" };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUID = user.uid;
                const defaultName = user.displayName || user.email.split('@')[0];
                document.getElementById('displayName').innerText = defaultName; 
                loadUserProfile(user.uid, user.email);
                loadOrderHistory(user.uid);
                loadWishlist(user.uid); // Tải wishlist
                checkSellerStatus(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // --- LOAD WISHLIST LOGIC ---
        function loadWishlist(userId) {
            const wishRef = ref(db, `users/${userId}/wishlist`);
            const container = document.getElementById('wishlistContainer');
            const loading = document.getElementById('wishlistLoading');

            onValue(wishRef, (snapshot) => {
                loading.style.display = 'none';
                container.innerHTML = "";
                
                if (snapshot.exists()) {
                    const wishlist = snapshot.val(); // Mảng tên game ['Elden Ring', 'Ace Slayer'...]
                    if (wishlist.length === 0) {
                        container.innerHTML = `<p style="color:#666; font-style:italic;">Chưa có game yêu thích nào.</p>`;
                        return;
                    }

                    wishlist.forEach(gameName => {
                        const gameInfo = GAME_LIBRARY[gameName];
                        if (gameInfo) {
                            // Tạo thẻ HTML cho game trong wishlist
                            container.innerHTML += `
                                <div class="purchased-game">
                                    <img src="${gameInfo.img}" alt="${gameName}">
                                    <div class="game-info">
                                        <h4>${gameName}</h4>
                                        <p>${gameInfo.price}</p>
                                    </div>
                                    
                                    <i class="fas fa-trash-alt remove-wish-btn" onclick="removeFromWishlist('${gameName}')" title="Xóa khỏi yêu thích"></i>
                                </div>
                            `;
                        }
                    });
                } else {
                    container.innerHTML = `<p style="color:#666; font-style:italic;">Chưa có game yêu thích nào.</p>`;
                }
            });
        }

        // --- XÓA KHỎI WISHLIST (Gắn vào window để gọi từ HTML) ---
        window.removeFromWishlist = function(gameName) {
            if(!confirm(`Xóa "${gameName}" khỏi yêu thích?`)) return;
            
            const wishRef = ref(db, `users/${currentUserUID}/wishlist`);
            get(wishRef).then((snapshot) => {
                if (snapshot.exists()) {
                    let wishlist = snapshot.val();
                    const index = wishlist.indexOf(gameName);
                    if (index > -1) {
                        wishlist.splice(index, 1);
                        set(wishRef, wishlist).then(() => alert("Đã xóa!"));
                    }
                }
            });
        }

        // ... (CÁC HÀM CŨ GIỮ NGUYÊN: loadUserProfile, openEditModal, saveProfile, sellGame, uploadAvatar, loadOrderHistory) ...
        
        function loadUserProfile(userId, email) {
            const userRef = ref(db, 'users/' + userId);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val() || {};
                currentProfileData = data;
                if (data.avatar) {
                    document.getElementById('avatarImg').src = data.avatar;
                    document.getElementById('avatarImg').style.display = 'block';
                    document.getElementById('defaultIcon').style.display = 'none';
                }
                document.getElementById('displayName').innerText = data.displayName || email.split('@')[0];
                document.getElementById('username').innerText = "@" + (data.username || "chua_dat_ten");
                document.getElementById('displayEmail').innerText = email;
                document.getElementById('joinDate').innerText = data.joinDate || new Date().toLocaleDateString('vi-VN');
                document.getElementById('interests').innerText = data.interests || "Chưa cập nhật";
                document.getElementById('userBio').innerText = data.bio || "Người dùng này rất bí ẩn...";
                if (!data.joinDate) update(ref(db, 'users/' + userId), { joinDate: new Date().toLocaleDateString('vi-VN') });
                document.getElementById('sellerContactEmail').value = email;
                document.getElementById('displayPhone').innerText = data.phone || "Chưa cập nhật";
            });
        }

        window.openEditModal = function() {
            document.getElementById('editDisplayName').value = document.getElementById('displayName').innerText;
            document.getElementById('editUsername').value = document.getElementById('username').innerText.replace('@', '');
            document.getElementById('editInterests').value = currentProfileData.interests || "";
            document.getElementById('editBio').value = currentProfileData.bio || "";
            document.getElementById('editPhone').value = currentProfileData.phone || "";
            document.getElementById('editProfileModal').style.display = "flex";
        };
        window.closeEditModal = function() { document.getElementById('editProfileModal').style.display = "none"; };

        window.saveProfileChanges = function(event) {
            event.preventDefault();
            if (currentUserUID) {
                update(ref(db, 'users/' + currentUserUID), {
                    displayName: document.getElementById('editDisplayName').value,
                    username: document.getElementById('editUsername').value,
                    phone: document.getElementById('editPhone').value,
                    interests: document.getElementById('editInterests').value,
                    bio: document.getElementById('editBio').value
                }).then(() => { alert("Cập nhật thành công!"); closeEditModal(); })
                  .catch((err) => { console.error(err); alert("Lỗi lưu!"); });
            }
        };

        window.openSellGameModal = function() { document.getElementById('sellGameModal').style.display = "flex"; };
        window.closeSellGameModal = function() { document.getElementById('sellGameModal').style.display = "none"; };

        document.getElementById('gameFileUpload').addEventListener('change', function(e) {
            if(e.target.files[0]) { document.getElementById('fileNameDisplay').innerText = "Đã chọn: " + e.target.files[0].name; }
        });

        window.submitSellerRequest = function(event) {
            event.preventDefault();
            if (!currentUserUID) return;
            const requestData = {
                studioName: document.getElementById('sellerStudioName').value,
                email: document.getElementById('sellerContactEmail').value,
                phone: document.getElementById('sellerPhone').value,
                gameName: document.getElementById('gameName').value,
                genre: document.getElementById('gameGenre').value,
                price: document.getElementById('gamePrice').value,
                description: document.getElementById('gameDesc').value,
                fileName: document.getElementById('gameFileUpload').files[0] ? document.getElementById('gameFileUpload').files[0].name : "Chưa chọn file",
                status: 'pending',
                requestDate: new Date().toLocaleString('vi-VN')
            };
            set(ref(db, `seller_requests/${currentUserUID}`), requestData)
            .then(() => { alert("Gửi đăng ký thành công!"); closeSellGameModal(); checkSellerStatus(currentUserUID); })
            .catch((err) => { console.error(err); alert("Lỗi kết nối!"); });
        };

        function checkSellerStatus(userId) {
            const reqRef = ref(db, `seller_requests/${userId}`);
            onValue(reqRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const btn = document.getElementById('btnSellGame');
                    if (data.status === 'pending') {
                        btn.innerHTML = '<i class="fas fa-clock"></i> ĐANG CHỜ DUYỆT';
                        btn.classList.add('pending'); btn.onclick = null;
                    } else if (data.status === 'approved') {
                        btn.innerHTML = '<i class="fas fa-check-circle"></i> ĐỐI TÁC CHÍNH THỨC';
                        btn.style.background = '#27ae60'; btn.style.color = '#fff';
                        btn.onclick = function() { alert("Trang quản lý game của bạn đang được xây dựng!"); };
                    }
                }
            });
        }

        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file || file.size > 800 * 1024) { alert("Ảnh quá nặng (>800KB)!"); return; }
            const reader = new FileReader();
            reader.onload = function(e) { if (currentUserUID) update(ref(db, 'users/' + currentUserUID), { avatar: e.target.result }); };
            reader.readAsDataURL(file);
        };

        function loadOrderHistory(userId) {
            const ordersRef = ref(db, 'orders/' + userId);
            const container = document.getElementById('ordersList');
            const loading = document.getElementById('loading');
            
            onValue(ordersRef, (snapshot) => {
                loading.style.display = 'none'; 
                container.innerHTML = ""; 
                let totalGamesCount = 0;
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Lấy danh sách đơn hàng và đảo ngược (Mới nhất lên đầu)
                    const orders = Object.values(data).reverse();
                    
                    orders.forEach(order => {
                        let gamesHtml = "";
                        if (order.items) {
                            totalGamesCount += order.items.length;
                            order.items.forEach(game => {
                                let priceText = game.price === 0 ? "FREE" : `$${game.price}`;
                                // Logic lấy link tải
                                let finalLink = game.downloadLink || GAME_SOURCE[game.name] || "#";
                                let downloadBtn = (finalLink && finalLink !== "#") 
                                    ? `<a href="${finalLink}" target="_blank" class="download-btn"><i class="fas fa-download"></i> Tải Game</a>` 
                                    : `<button class="download-btn disabled" disabled><i class="fas fa-clock"></i> Sắp ra mắt</button>`;
                                
                                // HTML từng game
                                gamesHtml += `
                                    <div class="purchased-game">
                                        <img src="${game.image}" alt="${game.name}">
                                        <div class="game-info">
                                            <h4>${game.name}</h4>
                                            <p>${priceText}</p>
                                        </div>
                                        ${downloadBtn}
                                    </div>`;
                            });
                        }
                        
                        // --- ĐÃ XÓA PHẦN NGÀY MUA Ở ĐÂY ---
                        // Chỉ hiển thị danh sách game, không hiện header ngày tháng nữa
                        container.innerHTML += `
                            <div class="order-card" style="border:none; padding:0; margin-bottom: 10px;">
                                <div class="game-list" style="display:flex; flex-direction:column; gap:10px;">
                                    ${gamesHtml}
                                </div>
                            </div>`;
                    });
                    
                    document.getElementById('gamesOwned').innerText = totalGamesCount;
                } else { 
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:#666;"><p>Chưa có đơn hàng nào.</p></div>`; 
                }
            });
        }
    </script>
    <script type="module" src="script.js"></script>
</body>
</html>